# =============================================================================
# Experiment Configuration Example
# =============================================================================
# Purpose: Template for defining experiments
#
# Usage:
#   Copy and modify for your experiment:
#   cp experiments.example.yml experiments.yml
#
# Related:
#   - docs/experiments.md
#   - services/assignment-service/API_SPEC.md
# =============================================================================

# -----------------------------------------------------------------------------
# Experiment Definitions
# -----------------------------------------------------------------------------
experiments:

  # ---------------------------------------------------------------------------
  # Example 1: A/B Test for Planner Policy
  # ---------------------------------------------------------------------------
  - name: planner_policy_exp
    description: "Test new planner model with improved leftovers optimization"
    unit_type: user        # user | household | session
    status: active         # draft | active | paused | completed
    start_at: "2025-01-01T00:00:00Z"
    end_at: null           # null for ongoing experiments
    
    variants:
      - name: control
        description: "Current production model"
        allocation: 0.5    # 50% of traffic
        config:
          policy_version_id: "uuid-policy-v1"
          params: {}
      
      - name: leftovers_v2
        description: "New model with leftovers optimization"
        allocation: 0.5    # 50% of traffic
        config:
          policy_version_id: "uuid-policy-v2"
          params:
            exploration_rate: 0.2
            leftovers_weight: 1.5

  # ---------------------------------------------------------------------------
  # Example 2: Gradual Rollout
  # ---------------------------------------------------------------------------
  - name: new_planner_rollout
    description: "Gradual rollout of new planner model"
    unit_type: household
    status: active
    start_at: "2025-01-15T00:00:00Z"
    end_at: null
    
    variants:
      - name: control
        description: "Current production"
        allocation: 0.9    # 90% of traffic
        config:
          policy_version_id: "uuid-policy-v3"
      
      - name: new_model
        description: "New model under test"
        allocation: 0.1    # 10% of traffic (start small!)
        config:
          policy_version_id: "uuid-policy-v4"
          params:
            temperature: 0.7

  # ---------------------------------------------------------------------------
  # Example 3: Multi-Variant Test
  # ---------------------------------------------------------------------------
  - name: meal_ranking_exp
    description: "Test different meal ranking strategies"
    unit_type: user
    status: draft          # Not yet active
    start_at: null
    end_at: null
    
    variants:
      - name: control
        description: "Baseline ranking"
        allocation: 0.4
        config:
          policy_version_id: "uuid-ranking-v1"
      
      - name: popularity_boost
        description: "Boost popular meals"
        allocation: 0.2
        config:
          policy_version_id: "uuid-ranking-v2"
          params:
            popularity_weight: 2.0
      
      - name: diversity_boost
        description: "Prioritize variety"
        allocation: 0.2
        config:
          policy_version_id: "uuid-ranking-v3"
          params:
            diversity_weight: 2.0
      
      - name: personalized
        description: "User preference learning"
        allocation: 0.2
        config:
          policy_version_id: "uuid-ranking-v4"
          params:
            use_preferences: true

  # ---------------------------------------------------------------------------
  # Example 4: Feature Flag (Simple On/Off)
  # ---------------------------------------------------------------------------
  - name: pantry_suggestions_exp
    description: "Test showing pantry-based suggestions"
    unit_type: user
    status: active
    start_at: "2025-02-01T00:00:00Z"
    end_at: null
    
    variants:
      - name: control
        description: "No pantry suggestions"
        allocation: 0.5
        config:
          feature_enabled: false
      
      - name: treatment
        description: "Show pantry suggestions"
        allocation: 0.5
        config:
          feature_enabled: true
          max_suggestions: 5

  # ---------------------------------------------------------------------------
  # Example 5: ML Model with Unified Config Format
  # ---------------------------------------------------------------------------
  # Uses execution_strategy: "mlflow_model" for traditional ML projects
  # This is the recommended format for new experiments
  - name: planner_model_v3_exp
    description: "Test new planner model using unified config format"
    unit_type: user
    status: active
    start_at: "2025-03-01T00:00:00Z"
    end_at: null
    
    variants:
      - name: control
        description: "Current production model"
        allocation: 0.5
        config:
          execution_strategy: "mlflow_model"
          mlflow_model:
            policy_version_id: "550e8400-e29b-41d4-a716-446655440000"
            model_name: "planner_model"
          params:
            temperature: 0.7
      
      - name: v3_model
        description: "New model version 3"
        allocation: 0.5
        config:
          execution_strategy: "mlflow_model"
          mlflow_model:
            policy_version_id: "660e8400-e29b-41d4-a716-446655440001"
            model_name: "planner_model"
          params:
            temperature: 0.8
            exploration_rate: 0.15

  # ---------------------------------------------------------------------------
  # Example 6: Conversational AI with Prompt Template
  # ---------------------------------------------------------------------------
  # Uses execution_strategy: "prompt_template" for chatbot/conversational AI
  # projects using LLM providers
  - name: chatbot_assistant_exp
    description: "Test different prompt templates for meal planning assistant"
    unit_type: user
    status: active
    start_at: "2025-03-15T00:00:00Z"
    end_at: null
    
    variants:
      - name: control
        description: "Baseline prompt template"
        allocation: 0.5
        config:
          execution_strategy: "prompt_template"
          prompt_config:
            prompt_version_id: "770e8400-e29b-41d4-a716-446655440002"
            model_provider: "anthropic"
            model_name: "claude-sonnet-4.5"
          flow_config:
            flow_id: "onboarding_v1"
            initial_state: "welcome"
          params:
            temperature: 0.7
            max_tokens: 2048
      
      - name: concise_prompt
        description: "More concise prompt template"
        allocation: 0.5
        config:
          execution_strategy: "prompt_template"
          prompt_config:
            prompt_version_id: "880e8400-e29b-41d4-a716-446655440003"
            model_provider: "anthropic"
            model_name: "claude-sonnet-4.5"
          flow_config:
            flow_id: "onboarding_v1"
            initial_state: "welcome"
          params:
            temperature: 0.5
            max_tokens: 1024

# -----------------------------------------------------------------------------
# Configuration Notes
# -----------------------------------------------------------------------------
# 
# 1. Allocation Rules:
#    - Total allocation should equal 1.0 (100%)
#    - Start new variants with â‰¤10% for safety
#    - Increase gradually based on monitoring
#
# 2. Naming Conventions:
#    - Experiment: {feature}_exp
#    - Control variant: control
#    - Treatment variants: descriptive name (e.g., leftovers_v2)
#
# 3. Config Structure:
#    
#    Legacy Format (still supported for backward compatibility):
#    - policy_version_id: Reference to exp.policy_versions
#    - params: Runtime parameters for the model
#    - feature_enabled: For simple feature flags
#
#    Unified Format (recommended for new experiments):
#    - execution_strategy: "mlflow_model" | "prompt_template" | "hybrid"
#    
#    For ML projects (execution_strategy: "mlflow_model"):
#    - mlflow_model.policy_version_id: Reference to exp.policy_versions
#    - mlflow_model.model_name: MLflow model name (optional)
#    - params: Runtime parameters
#
#    For Conversational AI (execution_strategy: "prompt_template"):
#    - prompt_config.prompt_version_id: Reference to exp.prompt_versions
#    - prompt_config.model_provider: LLM provider (e.g., "anthropic", "openai")
#    - prompt_config.model_name: Model identifier (e.g., "claude-sonnet-4.5")
#    - flow_config.flow_id: Conversation flow identifier (optional)
#    - flow_config.initial_state: Starting state in flow (optional)
#    - params: Runtime parameters
#
# 4. Status Lifecycle:
#    - draft: Configuring, no traffic
#    - active: Running, receiving traffic
#    - paused: Temporarily stopped
#    - completed: Analysis done
#
# -----------------------------------------------------------------------------
# TODO: Implementation Notes
# -----------------------------------------------------------------------------
# [ ] Add schema validation
# [ ] Add allocation validation (sum = 1.0)
# [ ] Add config loader
# [ ] Add experiment sync script

